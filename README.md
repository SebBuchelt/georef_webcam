# georef_webcam <img width="429" align="right" src="https://github.com/SebBuchelt/aux_data/blob/master/hintereisferner_webcam.jpg"> <br /> <br /> <img src="https://github.com/SebBuchelt/aux_data/blob/master/compare.gif" width="420" > 


## Python package to georeference webcam images <a href="https://doi.org/10.5281/zenodo.3898913"><img align="right" src="https://zenodo.org/badge/DOI/10.5281/zenodo.3898913.svg" alt="DOI"></a>

- **Maintainer**: Sebastian Buchelt
- **Citation**: Buchelt, S. (2020-): georef_webcam V.1.0. Zenodo. [https://doi.org/10.5281/zenodo.3898913](https://doi.org/10.5281/zenodo.3898913). <br /> _More on correct citation [here](https://github.com/SebBuchelt/georef_webcam/blob/master/README.md#citation)._
- **License**: CC-BY-NC-SA 4.0

## Overview

`georef_webcam` is a python package for `python3`. It provides functionalities to georeference oblique camera images in complex terrain without accurate knowlegde about the required input parameters.
The package enables the user to georeference images based on estimations about camera position, system parameters & looking direction. To run the projection you need the image you want to project and a high-resolution Digital Elevation Model (DEM) of the area covered by the camera. <br /> 
Additionally, Ground Control Points (GCPs) can be added to optimize the projection parameters for a better geolocation accuracy. <br /> <br /> 
`georef_webcam` uses the Matlab scripts of the [`PRACTISE` package](https://github.com/shaerer/PRACTISE) to run the projection procedure. Based on the output generated by `PRACTISE`, `georef_webcam` produces tif-files in the size of the original image with the coordinate position (Easting & Northing) of each pixel. Furthermore, a mask layer is generated to filter areas above the skyline. Based on those, a projected map of the camera image can be produced.

#### Requirements
Please look in [`requirements.txt`](https://github.com/SebBuchelt/georef_webcam/blob/master/requirements.txt) to see, which python libraries are required for the  `georef_webcam` package.
It is also mandatory to download & install the free software [`Octave`](https://www.gnu.org/software/octave/download.html), as the core projection procedure is running on Matlab/Octave scripts from [`PRACTISE` package](https://github.com/shaerer/PRACTISE). `PRACTISE` itself is downloaded automatically as the code has to be adapted for `georef_webcam`. <br />
So far this tool has been tested in Ubuntu 16.04, 18.04 & Windows 10.
<br /> <br />

## Installation
1. Download the package to the directory you like.
2. Install all required `python` packages to the conda environment you use (see [requirements.txt](https://github.com/SebBuchelt/georef_webcam/blob/master/requirements.txt)).
3. Download and install latest `Octave` version from [here](https://www.gnu.org/software/octave/download.html).
<br /> <br />

## Getting started
#### The following description gives a short idea, how the procedure works and how to get a good georeferencing result.

### Start georef_webcam:

Before starting the execution of the script, you should have the webcam image & the DEM file ready for processing. Then:
1. Activate environment 
2. set directory to downloaded package & start script:
```bash
$ cd /path/to/dowloaded/and/unzipped/folder/
$ cd /georef_webcam_v1_0/python_scripts
$ python georef_webcam.py in_dir out_dir [-n name_of_run]
```

The script georef_webcam.py requires two input parameter: 
- `in_dir`: directory, where the DEM file, the camera image and the gcp file (optional) are stored. The files can be stored in separate subdirectories.
- `out_dir`: directory, where output of `PRACTISE` and `georef_webcam` will be stored in subfolders.
- _`name_of_run`_ (optional): define a name for projection run to recognize output (default: test_run). <br /> <br />

### Parameter collection:
Two options: 
- read an already existing dictionary. The script searches for json-files in the input directory. After loading the dictionary, the parameters can also be edited then.
- Otherwise, if no previously generated dictionary exists or you want to generate a new set of projection parameters, a new dictionary will be created:
```ba
Do you want to create a new set of projection parameters?  y/n
```

**For details about input parameters, their definition and further requirements, see [Parameters.md](https://github.com/SebBuchelt/georef_webcam/blob/master/Parameters.md).**  <br />
The collected parameters are then stored as json-file under `in_dir/[name_of_run].json` and can be reused in a later run.
<br /> <br />

### Projection:
The parameters are taken from the dictionary and passed to `PRACTISE`, which is then executing the projection procedure. 
Afterwards, the DEM points projected into image plane are plotted in an Octave window and the geolocation accuracy of the projection can be checked:
<p align="center"><img width="90%" src="https://github.com/SebBuchelt/aux_data/blob/master/Octave_fig.png"></p>
<p align="center"><sub>Figure 1: DEM points projected into image plane. <br /> Left: wrong projection parameters; Right: Corrected projection parameters. </sub></p>

 Then you can decide between the following options:
```ba
Projection has been executed. 
What do you want to do next?
Please select one of the following options:
0: end procedure
1: edit projection input parameters and repeat projection procedure
2: produce georef_webcam output

Which of the options do you want to choose? 
```
- `0`: ends program
- `1`: edits projection parameters, stores them in new json file (optionally) and repeats the projection with the adapted parameters
- `2`: moves on to output generation <br /> <br />

### Output generation:
The following output is produced and stored in `out_dir/georef_result/name_of_run/` (_italic files are optional_):
- the original image
- `east_raster` & `north_raster`: two tif-files with the size of the image giving the easting & northing coordinate of each pixel
- _`alt_raster`:_ tif-file with altitude of each image pixel
- _`dist_raster`:_ tif-file with distance of each image pixel to camera location
- `mask`: tif-file containing the mask layer (needed to filter areas above skyline)
- _`[image_name]_map.tif`:_ projected map of the camera image
<br /><br />

## Output examples
<p align="center"><img width="45%" src="https://github.com/SebBuchelt/aux_data/blob/master/Easting.jpg"> <img width="45%" src="https://github.com/SebBuchelt/aux_data/blob/master/Northing.jpg"> </p>
<p align="center"><sub>Figure 2: Final result - Coordinate rasters. </sub></p>
<br>

<p align="center"><img width="90%" src="https://github.com/SebBuchelt/aux_data/blob/master/hintereisferner_webcam.jpg"></p>
<p align="center"><sub>Figure 3: Used webcam image. </sub></p>
<br>
<p align="center"><img width="90%" src="https://github.com/SebBuchelt/aux_data/blob/master/compare.gif"></p>
<p align="center"><sub>Figure 4: Animation showing same-day Sentinel-2 image overlayed with projected webcam image. </sub></p>
<br>

**More examples can be found [here](https://github.com/SebBuchelt/georef_webcam/blob/master/Examples.md).**

**Additional Comments on how to further improve geolocation accuracy can be found [here](https://github.com/SebBuchelt/georef_webcam/blob/master/Further_Comments.md).** <br /> (Only of interest, if you are already familiar with how the package works.) <br /> <br /> 

## Projecting other data
After successfully georeferencing an image, any other data or image with the same acquisition geometry can be projected to map coordinates. Besides RBG images also tif files with multiple bands can be projected with the following function `project_data2map.py`:

```bash
$ python project_data2map.py coord_dir filename_or_extension pixel_size out_dir 
         [-f IMAGE_FOLDER] [-fill FILL_NODATA]
```
 These input parameters are required: 
- `coord_dir`: directory, where the output of `georef_webcam` (coordinate rasters and mask) is stored.
- `filename_or_extension`: select the dataset or image, which should be projected. <br />
If you want to project several files, just insert a file extension instead (e.g. tif, png, jpg). <br /> 
In this case, the optional variable _`image_folder`_ is required. All datasets in this folder with the specified file extension will be projected.
- `pixel_size`: define spatial resolution of your product.
- `out_dir`: directory, where produced maps should be stored.
- _`fill_nodata`_ (optional): voids in the projected dataset can be filled with interpolation here. <br /> <br />

## Citation
Please cite `georef_webcam` as following:
- Buchelt, S. (2020-): georef_webcam V.1.0. Zenodo. [https://doi.org/10.5281/zenodo.3898913](https://doi.org/10.5281/zenodo.3898913).

As this work is primarily based on the [PRACTISE software](https://github.com/shaerer/PRACTISE) and its functionalities, please also cite:
- HÃ¤rer, S., Bernhardt, M., and Schulz, K.: PRACTISE: PRACTISE V.2.1. Zenodo, doi:10.5281/zenodo.35646, 2015. <br />

I also want to give special thanks to Gerhard Keuschnig & Florian Radlherr from [foto-webcam.eu](https://www.foto-webcam.eu), who provide a great system for high-resolution webcam images. The image in the example is provided by their website.<br /><br />

The reuse or adaptation of images and animations provided in the documentation files is only allowed upon request.
